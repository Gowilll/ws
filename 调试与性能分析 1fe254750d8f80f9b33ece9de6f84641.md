# 调试与性能分析

当一个Python脚本执行未通过时，会抛出异常。当解释器捕获到这些异常中的一个时，可以在轨迹追溯 `traceback`中找到引起这个错误的原因。

`%xmode`魔法函数允许你在异常发生时控制报错信息的数量。

`%xmode`有一个参数（模式），可选择3个模式中的一个作为参数。

| **模式** | **描述** |
| --- | --- |
| Plain | 最简单的轨迹追溯，只显示异常类型和错误信息（精简） |
| Context | 显示出错代码的上下文信息，包括相关代码行（默认） |
| Verbose | 最详细的模式，显示完整的变量和参数信息（显示更多详细信息） |

为什么不在所有场景中使用 `Verbose`？ 如果代码变得更复杂这种方式的轨迹追溯会变的非常长。选择另外两个简要描述更容易找到错误

### 调试，当阅读轨迹不足以解决问题时

标准的IPython交互式调试工具是pdb，他允许用户逐行运行代码，以便迅速找到错误原因。

增强版是ipdb。可以这么理解：

| **pdb** | **ipdb** |
| --- | --- |
| vi | vim |

IPython中最方便的调试工具——%debug魔法命令。

如果你在捕获异常后调用该调试器，他会在异常点自动打开一个交互式调试提示符。ipdb提示符探索栈空间的当前状态、可用变量、甚至运行Python命令。输入quit来结束调试

设置单步入栈和出栈来查看各变量的值

使用％pdb魔法函数可以在任何异常时都自动启用调试器

如果你有一个脚本，并希望以交互式模式运行，则可以使用 `%run -d`命令来运行，并利用next命令单步向下交互的运行代码

部分常用调试命令

| l (ist) | 显示文件的当前路径 |
| --- | --- |
| h (elp) | 显示命令列表，或查找特定命令的帮助信息 |
| q (uit) | 退出调试器和程序 |
| c (ontinue) | 退出调试器，继续运行程序 |
| n (ext) | 调到程序的下一步 |
| <enter> | 重复前一个命令 |
| p (rint) | 打印变量 |
| s (tep) | 步入子进程 |
| r (eturn) | 从子进程跳出 |

更多信息使用帮助命令

### 代码性能与耗时分析

％time

对单个语句的执行时间进行分析

％timeit

对单个语句的重复执行进行计时，以获取更高的准确度

％prun

利用分析器运行代码

％iprun

利用逐行分析器运行代码

％memit

测量单个语句的内存使用

％mprun

通过逐行的内存分析器运行代码

最后四个魔法命令不与IPython捆绑，需要安装

line_profiler和memory_profiler扩展

### 1、代码段计时：％timeit和％time

％timeit和％time通过让代码段重复运行来计算代码的运行时间。

对于较慢的命令％timeit将自动调整并减少重复运行的次数，减少次数表明准确性有稍微降低

重复运行代码计算时间有时并不是太好。例如，如果有一个列表需要排序，对于一个预先排好序的列表进行排序，比对一个无序的列表进行排序要快，所以要以重复运行将使结果成出现偏差。

对重复运行计算时间导致偏差的使用％time魔法命令比较好

较短的系统延迟对结果偏差较小的使用％time也是不错的

即使同样对以排列的列表进行排序，用％time也比％timeit计时花费的时间较长，这是％time在底层做了一些很聪明的的事情来阻止系统调用对计时过程的干扰，如：％time会阻止清理未利用的python对象（即垃圾回收），该过程会影响计时，所以％timeit比％time更快得到结果

％time和％timeit都可以通过双百分号语法实现多行代码的计时

更多信息通过帮助功能获取

### 对整个脚本进行性能分析：％prun

％prun对代码中的每个函数进行分析，对整个代码进行计时

通过％prun魔法函数实现对整个脚本计时，这比单个语句计时更重要。

运行输出是一个表格，包括函数调用的总时间，执行时间最多用在了哪里

### 用％lprun进行逐行性能分析

％lprun逐行代码分析报告。

python和ipython没有内置需要单独下载

$ pip install line_profiler

用Ipython导入line_profiler包提供的Ipython扩展

In[1]:%load_ext line_profiler

使用时写出要分析的函数，输出结果单位是微妙

### 用％memit和％mprun进行内存分析

分析内存量

安装

$ pip install memory_profiker

导入扩展

In[1]: %load_ext memory_profiler

内存分析扩展包含两个有用的魔法函数：

％memit——提供内存消耗计算功能，类似％timeit

％mprun——提供内存消耗计算功能，类似％％lprun

％mprun仅仅对独立模块的函数有效