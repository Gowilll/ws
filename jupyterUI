#!/bin/bash

# ----------------------------------------
# Jupyter Notebook ç®¡ç†è„šæœ¬
# åŠŸèƒ½ï¼šå®‰è£…ã€åˆ›å»ºç”¨æˆ·ã€ç”Ÿæˆé…ç½®ã€è®¾ç½®å¯†ç ã€å¯åŠ¨/åœæ­¢ æœåŠ¡ã€åˆ é™¤æ‰€æœ‰
# ----------------------------------------

# é»˜è®¤å‚æ•°
default_user="jpy"
default_port=8888

# é¢œè‰²è¾“å‡º
green()  { echo -e "\033[32m$1\033[0m"; }
yellow() { echo -e "\033[33m$1\033[0m"; }
red()    { echo -e "\033[31m$1\033[0m"; }

# å®‰è£… Jupyter Notebookï¼Œå¹¶é˜²æ­¢ getcwd() é”™è¯¯
install_jupyter() {
  cd ~ || cd /root || cd /tmp
  green "ğŸ“¦ æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…ä¾èµ–..."
  apt update
  apt install -y python3-pip curl
  green "ğŸ“¥ å‡çº§ pip å¹¶å®‰è£… Jupyter..."
  pip3 install --upgrade pip
  pip3 install jupyter
  green "âœ… Jupyter Notebook å®‰è£…å®Œæˆ"
  return_to_menu
}

# ç¡®ä¿ç”¨æˆ·ä¸»ç›®å½•å­˜åœ¨
ensure_home() {
  local username="$1"
  local home_dir="/home/$username"
  if [[ ! -d "$home_dir" ]]; then
    mkdir -p "$home_dir"
    chown "$username:$username" "$home_dir"
  fi
}

# åˆ›å»ºè¿è¡Œç”¨æˆ·
create_user() {
  read -p "ğŸ‘¤ è¯·è¾“å…¥è¿è¡Œç”¨æˆ·ï¼ˆé»˜è®¤: $default_userï¼‰: " username
  username=${username:-$default_user}
  if id "$username" &>/dev/null; then
    yellow "âš ï¸ ç”¨æˆ· $username å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
  else
    adduser --gecos "" --disabled-password "$username"
    green "âœ… ç”¨æˆ· $username åˆ›å»ºæˆåŠŸ"
  fi
  return_to_menu
}

# ç”Ÿæˆé…ç½®æ–‡ä»¶
generate_config() {
  read -p "ğŸ‘¤ è¯·è¾“å…¥è¿è¡Œç”¨æˆ·ï¼ˆé»˜è®¤: $default_userï¼‰: " username
  username=${username:-$default_user}
  ensure_home "$username"
  runuser -l "$username" -c "jupyter notebook --generate-config"
  green "âœ… å·²ä¸º $username ç”Ÿæˆé…ç½®æ–‡ä»¶äº: /home/$username/.jupyter/jupyter_notebook_config.py"
  return_to_menu
}

# è®¾ç½®ç™»å½•å¯†ç 
set_password() {
  read -p "ğŸ‘¤ è¯·è¾“å…¥è¿è¡Œç”¨æˆ·ï¼ˆé»˜è®¤: $default_userï¼‰: " username
  username=${username:-$default_user}
  ensure_home "$username"
  runuser -l "$username" -c "jupyter notebook password"
  green "âœ… å¯†ç è®¾ç½®å®Œæˆ"
  return_to_menu
}

# å¯åŠ¨ Jupyter Notebook
start_jupyter() {
  read -p "ğŸ‘¤ è¯·è¾“å…¥è¿è¡Œç”¨æˆ·ï¼ˆé»˜è®¤: $default_userï¼‰: " username
  username=${username:-$default_user}
  ensure_home "$username"
  read -p "ğŸŒ è¯·è¾“å…¥ç«¯å£ï¼ˆé»˜è®¤: $default_portï¼‰: " port
  port=${port:-$default_port}
  local home_dir="/home/$username"
  local log_file="$home_dir/jupyter.log"
  runuser -l "$username" -c "cd ~ && nohup jupyter notebook --allow-root --ip=0.0.0.0 --port=$port > $log_file 2>&1 &"
  server_ip=$(curl -s ifconfig.me || hostname -I | awk '{print $1}')
  green "ğŸš€ Jupyter å·²å¯åŠ¨ï¼šç«¯å£ $port"
  yellow "è®¿é—®åœ°å€: http://$server_ip:$port"
  return_to_menu
}

# åœæ­¢ Jupyter Notebook
stop_jupyter() {
  pkill -f jupyter && green "ğŸ›‘ Jupyter æœåŠ¡å·²åœæ­¢" || yellow "Jupyter æœªè¿è¡Œ"
  return_to_menu
}

# åˆ é™¤æ‰€æœ‰ï¼šJupyterã€ç”¨æˆ·åŠé…ç½®ï¼ˆå±é™©æ“ä½œï¼‰
delete_all() {
  read -p "âš ï¸ ç¡®è®¤åˆ é™¤æ‰€æœ‰é…ç½®å’Œç”¨æˆ·ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼è¾“å…¥ yes ç¡®è®¤: " confirm
  if [[ $confirm == "yes" ]]; then
    pkill -f jupyter
    deluser --remove-home "$default_user" 2>/dev/null
    pip3 uninstall -y jupyter
    green "ğŸ—‘ï¸ å·²åˆ é™¤ç”¨æˆ· $default_userã€Jupyter åŠæ‰€æœ‰é…ç½®"
  else
    yellow "å–æ¶ˆæ“ä½œ"
  fi
  return_to_menu
}

# è¿”å›ä¸»èœå•
return_to_menu() {
  echo
  read -p "æŒ‰ Enter è¿”å›èœå•..." _unused
  main_menu
}

# ä¸»èœå•
main_menu() {
  clear
  echo "====== Jupyter ç®¡ç†è„šæœ¬ ======"
  echo "1) å®‰è£… Jupyter Notebook"
  echo "2) åˆ›å»ºè¿è¡Œç”¨æˆ·"
  echo "3) ç”Ÿæˆé…ç½®æ–‡ä»¶"
  echo "4) è®¾ç½®ç™»å½•å¯†ç "
  echo "5) å¯åŠ¨ Jupyter æœåŠ¡"
  echo "6) åœæ­¢ Jupyter æœåŠ¡"
  echo "7) åˆ é™¤æ‰€æœ‰é…ç½®ä¸ç”¨æˆ·"
  echo "0) é€€å‡º"
  echo "============================"
  read -p "è¯·é€‰æ‹© [0-7]: " choice
  case "$choice" in
    1) install_jupyter ;;
    2) create_user ;;
    3) generate_config ;;
    4) set_password ;;
    5) start_jupyter ;;
    6) stop_jupyter ;;
    7) delete_all ;;
    0) exit 0 ;;
    *) red "æ— æ•ˆé€‰é¡¹" && return_to_menu ;;
  esac
}

# ç¡®ä¿ä»¥ root è¿è¡Œ
if [[ $EUID -ne 0 ]]; then
  red "è¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬"
  exit 1
fi

# å¯åŠ¨è„šæœ¬
main_menu
